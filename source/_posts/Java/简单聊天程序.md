---
title: Java简单聊天程序
category: Java
excerpt: 编写了一个简单的Java聊天程序，分为客户端和服务器端。服务器端如果在教研室电脑跑的话，需要在路由器中固定绑定主机mac和内网IP，然后再NAT中绑定内外端口映射。在客户端程序中设置服务端IP需要查看路由器的IP地址（ISP动态分配，可能会改变）。
---
设计思想：
- 服务器端：
  - 监听指定端口（如12345），一旦接收到Socket请求，就立马创建两个永远执行的线程（while(true)实现）。一个用于给客户端发送消息，一个用于接收从客户端来的消息。
- 客户端：
  - 根据服务器的IP和端口号，生成Socket，启动两个永远执行的线程，一个用于向服务器端发送消息，一个用于从服务器端接收消息。
- 注意：需要先启动服务器端，然后启动客户端。

```java
package MyChat;

import java.io.DataInputStream;
import java.io.DataOutputStream;
import java.io.IOException;
import java.net.Socket;
import java.util.Scanner;

public class ChatClient {
    private static final String ip = "219.230.70.7";	//从路由器管理界面抄下来的，此IP地址由ISP动态分配，可能会发生改变
    private static final int port=12345;	

    public static void main(String[] args) {
        Socket serverSocket = null;
        try {
            serverSocket = new Socket(ip, port);

            new Thread(new MessageToServer(serverSocket)).start();
            new Thread(new MessageFromServer(serverSocket)).start();

        } catch (IOException e) {
            e.printStackTrace();
        }

    }
}

class MessageToServer implements Runnable {
    private DataOutputStream dataOutputStream = null;
    private Scanner sc = new Scanner(System.in);

    public MessageToServer(Socket s) {
        try {
            dataOutputStream = new DataOutputStream(s.getOutputStream());
        } catch (IOException e) {
            e.printStackTrace();
        }
    }

    @Override
    public void run() {
        String message = null;
        while (true) {
            message=sc.nextLine();
            try {
                dataOutputStream.writeUTF(message);
            } catch (IOException e) {
                e.printStackTrace();
            }
        }
    }
}

class MessageFromServer implements Runnable {
    private DataInputStream dataInputStream = null;

    public MessageFromServer(Socket s) {
        try {
            dataInputStream = new DataInputStream(s.getInputStream());
        } catch (IOException e) {
            e.printStackTrace();
        }
    }

    @Override
    public void run() {
        String info=null;
        while(true){
            try {
                info=dataInputStream.readUTF();
                System.out.println("收到服务端消息："+info);
            } catch (IOException e) {
                e.printStackTrace();
            }
        }

    }
}
```

```java
package MyChat;

import java.io.DataInputStream;
import java.io.DataOutputStream;
import java.io.IOException;
import java.net.ServerSocket;
import java.net.Socket;
import java.util.Scanner;

public class ChatServer {
    public static void main(String[] args) {
        ServerSocket serverSocket = null; //服务端socket
        Socket clientSocket = null;   //客户端socket
        final int port = 12345;
        try {
            serverSocket = new ServerSocket(port);
            while (true) {    //监听端口，一旦收到新的scoket，则建立两个线程用于接收和发送消息
                clientSocket = serverSocket.accept();
                new Thread(new SendMessageToClient(clientSocket)).start();
                new Thread(new ReceiveClientMessage(clientSocket)).start();

            }
        } catch (IOException e) {
            e.printStackTrace();
        } finally {
            if(clientSocket!=null) {
                try {
                    clientSocket.close();
                } catch (IOException e) {
                    e.printStackTrace();
                }
            }
            if(serverSocket!=null) {
                try {
                    serverSocket.close();
                } catch (IOException e) {
                    e.printStackTrace();
                }
            }
        }

    }
}

class SendMessageToClient implements Runnable {
    DataOutputStream dataOutputStream=null;
    private Scanner sc=new Scanner(System.in);

    public SendMessageToClient(Socket s) {
        try {
            dataOutputStream=new DataOutputStream(s.getOutputStream());
        } catch (IOException e) {
            e.printStackTrace();
        }
    }

    @Override
    public void run() {
        String message=null;
        try{
            while(true){
                message=sc.nextLine();
                dataOutputStream.writeUTF(message);
            }
        }catch (IOException e){
            e.printStackTrace();
        }
    }
}

class ReceiveClientMessage implements Runnable {
    private DataInputStream dataInputStream = null;

    public ReceiveClientMessage(Socket s) {
        try {
            dataInputStream = new DataInputStream(s.getInputStream());
        } catch (IOException e) {
            e.printStackTrace();
        }
    }

    @Override
    public void run() {
        String message=null;
        try{
            while(true){    //一直运行，一旦接收到消息，就打印
                message=dataInputStream.readUTF();
                System.out.println("收到客户端消息："+message);
            }
        }catch (IOException e){
            e.printStackTrace();
        }
    }
}

```

