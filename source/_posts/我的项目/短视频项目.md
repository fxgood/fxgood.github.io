---
title: 短视频项目
category: 我的项目
excerpt: 记录独立完成前后端分离的短视频项目后端开发的过程
---

# 开发日志

[做完项目之后把这里边的问题回答一下](https://blog.csdn.net/weixin_48610702/article/details/115859656)

## 2022-7-11

今日工作

- 完成了互粉朋友列表的功能

问题:

- 查询互粉的朋友视频列表中用到了三表联合查询
  - vlog和users,用inner join联合查询,然后id in(fans中我粉的也粉我的用户的id)

- 多端登录和退出的问题,如何解决?

## 2022-7-7

- 完成了关注列表视频的功能
  - ps:发生了redis和数据库不一致的情况,数据库里边我关注了很多人,redis里却没有;

## 2022-7-6

- 完成视频点赞数的统计(两处,一处是刷新,另一处是在获取首页视频列表时)
- 完成展示我的点赞列表功能

## 2022-7-5

今日工作:

- 完成视频点赞和取消相关工作
  - 其中首页视频是否被我赞过,是在`getIndexVlogList`中写的

问题:

- REDIS和数据库的一致性问题! 
  - 是否点赞 是否关注 视频获赞数,用户获赞数,关注数这些东西,redis和数据库的一致性如何保持
  - 出现过的问题,我在项目完成的过程中,写入点赞信息的时候往redis和数据库中都写了,但是后来关闭vm之后,重新打开redis,这时候redis中数据不在.所以首页的视频显示视频没有点赞(读取redis),然后我再点点赞按钮,控制台显示数据库报错,`com.mysql.jdbc.exceptions.jdbc4.MySQLIntegrityConstraintViolationException Duplicate entry xxxx`违反数据库完成性约束的异常. 因为已经有该条目数据(某用户喜欢某视频,两个字段)

- 雪花算法是如何生成id的?有什么优点和缺点,有没有别的方法



## 2022-6-24

今日工作

- 完成取消关注功能从查询数据库改成查询redis!
- 实现查询关注列表功能(多表查询,因为要查Fans表还要查User表,需要编写mapper)
- 实现查询粉丝列表功能
- 实现互粉关系的查询(reids,如果在数据库中查询的话高并发下影响数据库性能)

知识点:

- Pagehelper实现分页的原理: 其实现了Mybatis的拦截器方法,重新拼接sql实现的.
- 自定义mybatis xml文件,写sql记得不要加`;` 否则会报错(分页Pagedhelper会在sql后边添加 limit)

问题:

- 如何做到redis和内存数据一致性的(我的项目里就出现这样的错误)

## 2022-6-23

今日工作

- 完成粉丝关注添加功能
- 实现了关注和取关功能(redis参与)

重点

- 粉丝计数和"我和博主的关联关系",要放入 redis,不要放入数据库,避免db性能瓶颈(网红可能有几千万粉丝,那么所有这样的人每次都进入db查询,会造成数据库崩溃)

## 2022-6-22

今日工作:

1. 开发了视频转私密和公开功能
2. 开发了查询自己的公开和私密视频列表功能

重点:

- 查询自己的公开和私密视频,这边需要分页,分页这块可以再重点看看

## 2022-6-9

今日工作

1. 使用unicloud的cdn实现了视频上传功能
1. uicloud地址:https://unicloud.dcloud.net.cn/cloud-storage?platform=aliyun

问题:

1. 登录逻辑中,不能多端登录,会覆盖掉之前的设备登录的token,如何解决?
2. 查询视频,分页那块,没咋整明白,回头再看一下

## 2022-6-8

今日工作

1. 开发了退出登陆功能
2. 实现了用户信息查询功能
3. 部署了minio,**注意如果不注释掉okhttp,测试minio文件上传的时候会报错**(注意,注释掉以后,要刷新maven)

收获

1. 粉丝,关注,获赞等信息直接从数据库获取的话,数据库压力很大,因此单独采用redis来做
2. 我的`@Confugiration`的理解: 配置类,把原来的xml形式对bean的配置转换为注解+yml配置文件形式.基本内部都是通过@Value读取配置文件中的属性,然后生成对应的Bean交给Spring进行管理

问题:

1. 我对枚举类型不是很熟悉,需要去学一下
2. 为什么需要用到分布式存储MinIO?项目中根本没有体现分布式,能否自己实现一下?
   - xx

坑:

1. 要存emoji表情,必须修改mariadb的字符集为utf8mb4,在安装目录下`data\my.ini`中修改即可
2. minio不能运行,用sudo ./minio server xxx 即可(minio在 /usr/local/bin下)
   - 注意,虚拟机要开启桥接模式而非NAT
     - NAT模式下:虚拟机和主机处于同一个局域网,但是虚拟机不和其他设备如连到同一个wifi的手机,在一个局域网.如果使用NAT模式,则手机上无法访问minio存储的文件
     - 桥接模式下:虚拟机,主机,其他所有连到同一个wifi的设备,都处于同一个无线网下
   - 注意:启动minio要设置`--console-address 0.0.0.0:9111`,这样所有设备都能访问控制台
   - 端口:http://192.168.1.106:9000

重点与难点:

1. 视频上传这块,使用传统的上传方式和CDN上传的区别

## 2022-6-7

今日工作:

1. 完成了腾讯云短信功能的认证
2. 完成验证码相关功能,集成腾讯云短信sdk,成功调用api发送验证码到手机上.

今日收获与感悟:

1. 接触了Knife4j的用法
2. 接触了lombok的用法
3. 接触了Slf4j的用法
4. 接触了Hibernate验证框架校验数据的用法
5. 接触了RDM的使用
6. 使用ubuntu安装了redis,然后在windows中用SecureCRT连接到虚拟机中的reids,用RDM连接到虚拟机中的redis.练习了一些linux命令的使用
7. 前后端分离的好处:
   - 静态资源(前端页面)与动态资源分离,可以将静态资源放入缓存,大大提升访问效率.
   - 开发职责分离,让专业的人做专业的事情
   - 前后端的开发互相透明,只需要约定接口即可.前后端可以独立测试,发布.
8. 数据库实体,pojo,xml文件等,都是通过逆向工具生成的,surprise! 很棒

问题

1. 为什么前后端分离不能使用session?
2. 全局唯一ID如何实现的?
   - 雪花算法?
   - 美团和百度如何解决雪花算法的缺陷的?
3. 异常的封装和全局统一拦截具体怎么做的?
4. 枚举类的用法?
5. @bean和@Autowired有什么区别?
6. 数据层的访问怎么实现的?那一堆example,mapper啥的,怎么实现的?mybatis的接口+xml,提供自动代理是怎么实现的?

重点:

1. 对数据的校验,比如手机号码长度,验证码是否为空等.交给hibernate 验证框架来解决,发生错误抛出异常,再由统一异常拦截处理,将错误信息返回给前端
   - 原来是在每个单独处理,非常麻烦,这样改造之后条理清晰.
2. redis的使用
   - 存储定时60s的用户ip,保证一个用户60s内只能请求一次验证码
   - 存储用户验证码,用于登录校验

# 软件安装

- 用HbuilderX连接iphone的时候,要先打开itunes

- idea调整vm参数在菜单`help-edit custom vm options`

```
-Xmx6096m
-Xms4096m
```

- SecureCRT许可证

```
运行程序，选择菜单“帮助 > 输入许可数据”启动“许可向导”。
将以下数据复制并粘贴到“许可向导”的相应字段中即可。
名字：Windows
公司：IC
序列号：03-50-008187
许可密钥：ACDDHB JQ2D9S 7ZAA5G CVNX41 ADAQB9 6ZVPYK PQ4EF1 84V5JM
发布日期：26-07-2006
```



- minio的安装

```
下载服务端
wget https://dl.min.io/server/minio/release/linux-amd64/minio -O /usr/local/bin/minio && chmod +x /usr/local/bin/minio
下载客户端
wget https://dl.min.io/client/mc/release/linux-amd64/mc -O /usr/local/bin/mc && chmod +x /usr/local/bin/mc
```

- 腾讯云的配置
  - 一个是在common-src-main-java-resources-tencentcloud.properties
  - 一个是在SMSUtils中

- cmd方式进入mariadb客户端
  - 环境变量
  - 进入mariadb的bin下输入`mysql -u root -p` 密码123456

# linux使用

- secureCRT连接linux

  - 虚拟机网络调成桥接模式,设置固定ip(在系统设置-network-wired-右下角options-ipv4 settings)
    - 网关和dns服务器是192.168.1.1
  - 进入linux, ifconfig查看ip地址
  - 在secureCRT中连接
  - 账号root 密码一个空格

- 启动redis

  - 启动redis服务端 redis-server [配置文件] [&后台启动]
  - 启动redis客户端 redis-cli

- 启动minio

  - 切换到minio的目录下(minio在 /usr/local/bin下)
  - `sudo ./minio server --console-address 0.0.0.0:9111 data` 
    - `--console-address 0.0.0.0:9111`,这样所有设备都能访问控制台
    - data那个是表示数据存储在 `data/`下
  - 控制台 `http://192.168.1.xxxx:9111`
  - 账号密码都是`minioadmin`

  
