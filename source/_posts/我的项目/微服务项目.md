---
title: 微服务优惠券项目
date: 2021-6-1
category: 我的项目
excerpt: 从头完整做一个微服务架构的商城优惠券项目。
---

# 项目简介
## 微服务架构与传统架构的区别
- 传统架构（单体服务）
 	- 优点
		- 所有功能集中在一起，结构简单
	- 缺点 
		- 编写代码时，各种功能可能会发生冲突 	
		- 需要修改某一功能时，需要重新编译整个项目
		- 当某一功能发生故障时，可能会拖垮整个项目业务系统
- 微服务
	- 微服务即将原本大系统中的各个功能点拆分为独立的小系统，并独立部署。致力于解决单体服务的各种弊端 
	- 优点
		- 客户端不直接与微服务进行交互，而是通过网关做路由请求的分发
		- 功能之间的方法调用，变成了微服务之间的服务调用
		- 让开发、部署过程变得简单易维护  
		- 某个微服务出现问题，不会影响其他的微服务，对业务系统的高可用提供了保障
## 项目架构
![在这里插入图片描述](https://yfx-blog-image.oss-cn-hangzhou.aliyuncs.com/img/20210707150408288.png)

## 涉及的技术
- Java
- Maven
- SpringCloud
- MySQL、Redis、Kafka

# Maven
Maven是一种项目构建工具 
## 相关特性
- 传递依赖与排除依赖
	- 如果项目引用了一个jar包，而该jar包又引用了其他jar包。那么，默认情况下，项目编译时，Maven会把直接引用和间接引用的jar包都下载到本地（`~/.m2/repository`)
	- 排除依赖：如果我们指向下载直接引用的jar包，那么需要在`pom.xml`中做如下配置（给出需要排除的坐标）
	<img src="https://yfx-blog-image.oss-cn-hangzhou.aliyuncs.com/img/20210707154948393.png" width=50%>
- 依赖冲突
	- 说明：如果项目中多个jar同时引用了相同的jar时，会产生依赖冲突，但Maven采用了两种避免冲突的策略，因此在Maven中是不存在依赖冲突的。
	- 短路优先
		- `本项目->A.jar->B.jar->X.jar`
		- `本项目->C.jar->X.jar `
	- 声明优先
		- 若引用路径长度相同时，在`pom.xml`中，谁先被声明，就是用谁 
- 多模块项目/聚合
	- 为什么需要多个模块构成一个项目？
		-  项目很大的情况下，编译时间很长，只是改动某处的代码却需要编译整个项目
		- pom文件可以用来继承和重用，如果另一个项目需要用到这个项目中的某个模块，在不分模块的情况下（只有一个jar包或者war包），就只能依赖于一个很大的包，将整个项目都依赖进去。项目很大的情况下，维护困难，可重用性低。  
	- `dependencyManagement`和`dependencies`标签的区别
		- `dependencies`子模块默认集成父项目的依赖项，全部继承
		-  `dependencyManagement`只在父模块中声明依赖而不引入，子模块如果引入需要显示声明
	- 父模块与子模块的关系
		- 父模块管理所有jar包，子模块引用父模块即可，无需重复定义
		- 父模块没有代码，只有pom文件管理所有的依赖，以及共同的配置
		- 父模块packaging类型必须是pom（默认是jar）
		![在这里插入图片描述](https://yfx-blog-image.oss-cn-hangzhou.aliyuncs.com/img/20210707165623993.png)
		![在这里插入图片描述](https://yfx-blog-image.oss-cn-hangzhou.aliyuncs.com/img/20210707165840836.png)
# Redis
## 支持的数据类型
- String
- List
	- 双向链表实现 
- Hash 
- Set
- SortedSet
	- 每个元素关联一个浮点型的权重值 
## Redis特性
- Redis的所有操作都是原子的
	- 一个操作要不全部完成，要不就不做
	- 源自Redis的单线程
- Redis可以对key设置过期时间（后面两种是Redis对key的删除方式）
	- 定时删除
	- **惰性删除**
	- **定期删除**
- Redis支持两种持久化方式
	- RDB（快照，默认）：一次性将redis数据全部写入磁盘文件中，在线上操作中几乎不被采用 
	- AOF(append only file)：将用户的每一个写指令（添加、修改、删除），都备份到文件中，还原数据的时候，执行具体的写指令
- Redis速度快的原因
	- 完全基于内存
	- 数据结构简单
	- 单线程，没有切换
	- 多路IO复用模型
		- select
		- epoll 
- 缓存穿透和缓存雪崩的问题
	- 缓存穿透：指查询一个不存在的数据，但是由于Cache不命中，又需要去DB中查询，造成性能下降
		- 解决方案：给没有命中的key设定“没有意义的空值”(防止对该key反复访问数据库）
	- 缓存雪崩：指Cache设置了相同的过期时间，导致Cache在同一时间失效，请求全部转发到DB，DB的瞬间压力过大，造成雪崩
		- 解决方案：给key设定不同的（随机的）过期时间     
## Redis的IO模型
### BIO
- BIO：Blocking I/O 阻塞模型
- 阻塞模型的特点
	- 当read/write对某一文件描述符(FD)进行读写时，如果当前的FD不可读或者不可写，则服务阻塞 
### I/O多路复用
在客户端/服务器的模型下：多个客户端（应用）向服务器（内核）请求数据（请求完后可以去做别的事情），服务器中有一个selector监听各个客户端请求的数据是否准备好，如果准备好了则发送消息通知客户端。
![在这里插入图片描述](https://yfx-blog-image.oss-cn-hangzhou.aliyuncs.com/img/20210709202603285.png)

- 多路复用模型的特点：
	- 同时监控(select/epoll)多个文件描述符的可读可写情况，当其中的某些文件描述符可读或者可写时，就会返回可读以及可写的文件描述符（个数）
### Redis的Reactor设计模式
![在这里插入图片描述](https://yfx-blog-image.oss-cn-hangzhou.aliyuncs.com/img/20210709202842492.png)
# MySQL
## 版本
 - 目前企业级开发中最常用的版本
 	- MySQL5.5（又叫MySQL5）
 	- MySQL5.6（又叫MySQL6）
 	- MySQL5.7（又叫MySQL7）
- MySQL官方主推的版本
	- MySQL8.0  
	- MySQL 8 Up to 2X Faster Than MySQL5.7
- MySQL8.0配置
	- pom.xml的配置
	<img src="https://yfx-blog-image.oss-cn-hangzhou.aliyuncs.com/img/20210709204309855.png" width=50%>
	- jdbc驱动类的配置
	driver-class-name:com.mysql.**cj**.jdbc.Driver
	- 数据库时区的配置(如果未设置时区，可能会报Time Zone错误）
	set GLOBAL time_zone='+8:00';
## InnoDB索引原理
### B树和B+树
B树是一种多路平衡查找树，B是Balance，m阶（m>=2）的B树有以下特性：
1. 树中的每个子节点最多有m个子节点
2. 除了根节点和叶子节点以外，其他每个节点至少有m/2个子节点
3. 所有的叶子节点都在同一层
4. 节点中关键字的顺序按照升序排列
![三阶B树](https://yfx-blog-image.oss-cn-hangzhou.aliyuncs.com/img/20210709205008930.png)
B+树是B树的一种变体，同样是多路平衡查找树，它与B树主要的不同是
5. 非叶子节点不存储数据，只存储索引
6. 叶子节点包含了全部的关键字信息，且叶子节点按照关键字顺序相互连接
> Mysql索引主要使用的是B+树
### 聚簇索引
#### 聚簇索引的含义
每个InnoDB的表都有一个索引，称之为聚簇索引，此索引中存储着行记录，一般来说，聚簇索引是根据主键生成的。
#### 聚簇索引的创建规则
![在这里插入图片描述](https://yfx-blog-image.oss-cn-hangzhou.aliyuncs.com/img/20210709205823768.png)
### 辅助索引
#### 辅助索引的含义
除了聚簇索引之外的索引都可以称之为辅助索引，与聚簇索引的区别在于，辅助索引的叶子节点中存放的是主键的键值
#### 辅助索引的两次查找行记录
![在这里插入图片描述](https://yfx-blog-image.oss-cn-hangzhou.aliyuncs.com/img/20210709210300396.png)
### 常见索引类型![在这里插入图片描述](https://yfx-blog-image.oss-cn-hangzhou.aliyuncs.com/img/20210709210525135.png)
> 索引本质是一张表，保存的是主键与索引的字段，并且指向实体表的记录
## Spring Data Jpa
- 什么是JPA
即Java Persistence API，用于对象持久化的API，它是**ORM规范**(不是具体实现，只是定义了接口)，使得应用程序以统一的方式访问持久层。
<img src="https://yfx-blog-image.oss-cn-hangzhou.aliyuncs.com/img/20210709215142190.png" width=50%>
- ORM规范
ORM 是 Object Relational Mapping 的缩写，译为 “对象关系映射” 框架。所谓的 ORM 框架就是一种为了解决面向对象与关系型数据库中数据类型不匹配的技术，它通过描述 Java 对象与数据库表之间的映射关系，自动将 Java 应用程序中的对象持久化到关系型数据库的表中。ORM 框架是一种数据持久化技术，即在**对象模型和关系型数据库之间建立起对应关系**，并且提供一种机制，可通JavaBean 对象操作数据库表中的数据。
- JPA和Hibernate的关系
	-  JPA是Hibernate的一个抽象
	- JPA是ORM规范，不是ORM框架
	- Hibernate是JPA的一种实现
	- JPA是Hibernate的一个功能子集
> Hibernate 在查询不复杂、并发量小的情况下比较合适，查询复杂、并发量高的情况下用Mybatis，只要适合应用场景的就是好的技术。
- JPA的优势
	- 标准化
	- 简单易用
	- 面向对象
- JPA包含的技术
	- ORM映射元数据
		描述对象和表中数据的映射关系  
	- 提供了查询API
	- 查询语句（JPQL）
	通过面向对象而非面向数据库的查询语言去查询数据，避免程序和具体的SQL耦合在一起
- Spring Data项目
	- Spring Data是Spring的一个子项目，用于简化数据库访问
	- Spring Data JPA是Spring Data的一个子项目
	- Spring Data JPA致力于减少数据访问层（DAO）的开发量  
## 数据库连接池
- 数据库连接池能够做什么
**连接复用**：通过简历一个数据库连接池以及一套连接使用管理策略，使得一个数据库可以得到高效、安全的复用，避免了数据库链接频繁简历、关闭的开销。
- 数据库连接池的基本原理
	数据库连接池的基本原理是在内部对象池中维护一定数量的数据库链接，并对外暴露数据库连接获取和返回方法
	- getConnection
	- releaseConnection
- 使用数据库连接池的优势
	- 资源重用
	- 更快的系统响应
	- 优化的资源分配
	- 统一的连接管理 
- SpringBoot2默认的数据库连接池
![在这里插入图片描述](https://yfx-blog-image.oss-cn-hangzhou.aliyuncs.com/img/20210710110846280.png)
# Kafka
## 消息系统
- 点对点消息系统
<img src="https://yfx-blog-image.oss-cn-hangzhou.aliyuncs.com/img/20210710111106317.png" width=70%>
- 发布订阅消息系统
<img src="https://yfx-blog-image.oss-cn-hangzhou.aliyuncs.com/img/20210710111145394.png" width=70%>
## Kafka术语
![在这里插入图片描述](https://yfx-blog-image.oss-cn-hangzhou.aliyuncs.com/img/202107101112313.png)
- 当需要保持消息的顺序时，可以设置partition数量为1（默认是1）
- kafka Brokers有自动负载均衡的功能

## Kafka的使用
![在这里插入图片描述](https://yfx-blog-image.oss-cn-hangzhou.aliyuncs.com/img/20210710111841790.png)

## Kafka Producer消息分区
![在这里插入图片描述](https://yfx-blog-image.oss-cn-hangzhou.aliyuncs.com/img/20210710140201472.png)
> 使用key指定分区，在实际开发中并不常用
## Kafka Consumer消费组
![在这里插入图片描述](https://yfx-blog-image.oss-cn-hangzhou.aliyuncs.com/img/20210710140526820.png)
![在这里插入图片描述](https://yfx-blog-image.oss-cn-hangzhou.aliyuncs.com/img/20210710141027105.png)

- Kafka保证，一个tipic中的每个信息，只被消费者组中的一个成员消费
- 消费者总是属于一个消费者组，即使不指定消费者组，kafka也会默认地将其放入一个消费者组中（只有它一个）

# SpringBoot
## SpringBoot应用启动入口
- 应用启动的三种方式
	- SpringAppliction静态方法run
	- 通过Api调整应用行为
	- SpringApplicationBuilder的Fluent Api，实现链式调用 
## 自动配置原理（starter）
![在这里插入图片描述](https://yfx-blog-image.oss-cn-hangzhou.aliyuncs.com/img/2021071017445186.png)
## 配置文件
- 统一目录下的application和bootstrap
	- bootstrap优先级高于application，优先被加载
	- bootstrap用于应用程序上下文的引导阶段，由父ApplicationContext加载
	- bootstrap是系统级别的配置（不变的参数），application是应用级别的配置
- 不同位置的配置文件加载顺序（优先级）
  ![在这里插入图片描述](https://yfx-blog-image.oss-cn-hangzhou.aliyuncs.com/img/2021071017490269.png)
  
## 配置注入的方式
即数据绑定的方式，有两种
1. 通过配置直接注入
![在这里插入图片描述](https://yfx-blog-image.oss-cn-hangzhou.aliyuncs.com/img/20210710184054390.png)
2. 通过类注入
![在这里插入图片描述](https://yfx-blog-image.oss-cn-hangzhou.aliyuncs.com/img/20210710184121465.png)
## 定时和异步任务
 ![在这里插入图片描述](https://yfx-blog-image.oss-cn-hangzhou.aliyuncs.com/img/2021071019312449.png)

## 单元测试
## 开机启动
## Actuator监控

# 遇到的问题及解决方案
1. 在resources中自定义配置，编辑application.yml文件时，报错
解决方法：书写键值的时候要加空格，如`port: 8000`，否则就会报错